name: Integration tests

on:
  workflow_call:
    inputs:
      node_version_file:
        description: "Passed to setup-node action to specify where to source the version of node from"
        required: false
        type: string
        default: ".nvmrc"

permissions:
  contents: read

jobs:
  integration-tests:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d postgres"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20

    steps:
      - uses: actions/checkout@v4

      - name: Wait for Postgres and create app DB
        shell: bash
        env:
          PSQL: postgres://postgres:postgres@127.0.0.1:5432/postgres
        run: |
          for i in {1..60}; do
            pg_isready -h 127.0.0.1 -p 5432 -U postgres -d postgres && break
            sleep 1
          done
          psql "$PSQL" -v ON_ERROR_STOP=1 -c "SELECT 1;"
          psql "$PSQL" -v ON_ERROR_STOP=1 -tc "SELECT 1 FROM pg_database WHERE datname='wmt'" | grep -q 1 || \
            psql "$PSQL" -v ON_ERROR_STOP=1 -c "CREATE DATABASE wmt;"

      - name: Checkout hmpps-workload
        uses: actions/checkout@v4
        with:
          repository: ministryofjustice/hmpps-workload
          path: hmpps-workload
          # ref: main  # optionally pin a branch/sha

      - name: Run Flyway migrations from hmpps-workload (CLI)
        shell: bash
        run: |
          set -euo pipefail
          # Find the migrations directory inside hmpps-workload
          MIG_DIR=$(find hmpps-workload -type d -path '*/src/main/resources/db/migration' | head -n1)
          if [ -z "$MIG_DIR" ]; then
            echo "❌ Could not find src/main/resources/db/migration in hmpps-workload"
            exit 1
          fi
          echo "Using migrations at: $MIG_DIR"

          # Run Flyway CLI via Docker; --network host lets Docker reach 127.0.0.1:5432 on the runner
          docker run --rm --network host \
            -v "$PWD/$MIG_DIR":/flyway/sql \
            flyway/flyway:10 \
            -url=jdbc:postgresql://127.0.0.1:5432/wmt \
            -user=postgres \
            -password=postgres \
            -connectRetries=60 \
            -locations=filesystem:/flyway/sql \
            migrate

      # --- now start your deps/app and run integration tests as you already do ---
      - name: Get WireMock
        run: curl -sSLo wiremock.jar https://repo1.maven.org/maven2/org/wiremock/wiremock-standalone/3.9.1/wiremock-standalone-3.9.1.jar

      - name: Start WireMock(s)
        run: |
          for p in 9091; do
            nohup java -jar wiremock.jar --port "$p" >/tmp/wm-$p.log 2>&1 &
          done

      - name: Install deps
        run: npm ci

      - name: Start app & run integration tests
        env:
          # Ensure your app uses these (or DATABASE_URL) to connect
          PGHOST: 127.0.0.1
          PGPORT: "5432"
          PGUSER: postgres
          PGPASSWORD: postgres
          PGDATABASE: wmt
          PGSSLMODE: disable
          # DATABASE_URL: postgres://postgres:postgres@127.0.0.1:5432/wmt?sslmode=disable
        run: |
          nohup npm run start-feature >/tmp/app.log 2>&1 &
          sleep 5
          npm run integration-test